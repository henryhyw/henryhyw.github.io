<div class="menu">
  <nav class="menu-content">
    {% for item in site.data.settings.menu %}
      <a href="{{ site.github.url }}/{{ item.url }}">{{ item.name }}</a>
    {% endfor %}
  </nav>
<!--   <nav class="social-icons">
    {% include social-icons.html %}
  </nav> -->
  <nav class="social-icons">
    <a id="music-icon" title="Play Music"><i class="fa fa-compact-disc" aria-hidden="true" style="font-size: 2em;"></i></a>
  </nav>
</div>

<audio id="background-music"></audio>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const musicIcon = document.getElementById("music-icon");
    const music = document.getElementById("background-music");

    const songs = [
      '/assets/aud/daylight.mp3',
      '/assets/aud/uletali_pticami_gordymi.mp3',
      '/assets/aud/the_portrait.mp3',
      // Add more song paths here if needed
    ];

    function getRandomSong() {
      return songs[Math.floor(Math.random() * songs.length)];
    }

    function playSong(song) {
      console.log(`Playing song: ${song}`);
      music.src = song;
      music.play().catch(error => {
        console.log("Autoplay prevented. Waiting for user interaction.");
        // Update play status to false and stop spinning
        localStorage.setItem("musicPlaying", "false");
        musicIcon.querySelector("i").classList.remove("fa-spin");
        musicIcon.title = "Play Music";
      });
      musicIcon.querySelector("i").classList.add("fa-spin");
      musicIcon.title = "Pause Music";
    }

    function playRandomSong() {
      const randomSong = getRandomSong();
      console.log(`Random song selected: ${randomSong}`);
      localStorage.setItem("currentSong", randomSong);
      playSong(randomSong);
    }

    // Restore music state from localStorage
    const savedSong = localStorage.getItem("currentSong");
    const savedTime = localStorage.getItem("musicTime");
    const musicPlaying = localStorage.getItem("musicPlaying") === "true";

    if (savedSong) {
      console.log(`Restoring song: ${savedSong}`);
      music.src = savedSong;
      if (savedTime) {
        music.currentTime = savedTime;
        console.log(`Restoring time: ${savedTime}`);
      }
      if (musicPlaying) {
        music.play().catch(error => {
          console.log("Autoplay prevented. Waiting for user interaction.");
          // Update play status to false and stop spinning
          localStorage.setItem("musicPlaying", "false");
          musicIcon.querySelector("i").classList.remove("fa-spin");
          musicIcon.title = "Play Music";
        });
        musicIcon.querySelector("i").classList.add("fa-spin");
        musicIcon.title = "Pause Music";
        console.log("Music is playing");
      } else {
        musicIcon.title = "Play Music";
        console.log("Music is paused");
      }
    } else {
      musicIcon.title = "Play Music";
      console.log("No saved song, ready to play a new one");
    }

    musicIcon.addEventListener("click", function() {
      if (music.paused) {
        if (!music.src) {
          playRandomSong();
        } else {
          music.play().catch(error => {
            console.log("Autoplay prevented. Waiting for user interaction.");
            // Update play status to false and stop spinning
            localStorage.setItem("musicPlaying", "false");
            musicIcon.querySelector("i").classList.remove("fa-spin");
            musicIcon.title = "Play Music";
          });
          musicIcon.querySelector("i").classList.add("fa-spin");
          musicIcon.title = "Pause Music";
        }
        localStorage.setItem("musicPlaying", "true");
        console.log("Music started");
      } else {
        music.pause();
        musicIcon.querySelector("i").classList.remove("fa-spin");
        musicIcon.title = "Play Music";
        localStorage.setItem("musicPlaying", "false");
        console.log("Music paused");
      }
    });

    // Save music state before leaving the page
    window.addEventListener("beforeunload", function() {
      localStorage.setItem("musicTime", music.currentTime);
      localStorage.setItem("musicPlaying", !music.paused);
      if (music.src) {
        localStorage.setItem("currentSong", music.src);
        console.log(`Saving song: ${music.src}`);
      }
    });

    // Play next random song when the current one ends
    music.addEventListener("ended", function() {
      console.log("Song ended, playing next random song");
      playRandomSong();
    });

    // Automatically continue playback if it was playing before
    if (musicPlaying && savedSong) {
      music.play().catch(error => {
        console.log("Autoplay prevented on load. Waiting for user interaction.");
        // Update play status to false and stop spinning
        localStorage.setItem("musicPlaying", "false");
        musicIcon.querySelector("i").classList.remove("fa-spin");
        musicIcon.title = "Play Music";
      });
    }
  });
</script>